<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Was ist los?</title>

    <script src="js/mongo_query.js"></script>
    <script>

        // fill the form
        function map() {
            emit(this.meta.source, 0)
        }

        function render(res) {
            var newspapers = res.map(e => e["_id"]);

            var checkboxHtml = newspapers.map(e => '<label for="' + e + '">' + e + '</label><input type="checkbox" id="' + e + '"><br>');
            document.getElementById("newspapers").innerHTML = checkboxHtml.reduce((a, b) => a + b);

            Array.from(document.getElementsByTagName("input")).forEach(el => el.onchange = () => {
                var from = document.getElementById("from").value;
                var to = document.getElementById("to").value;

                from = +new Date(from) / 1000;
                to = +new Date(to) / 1000;

                var sources = newspapers.filter(elem => document.getElementById(elem).checked);

                var query = {
                    "meta.timestamp": {"$gte": from},
                    "meta.timestamp": {"$lte": to},

                    "meta.source": {"$in": sources}
                };

                if (!(sources && from && to)) return;

                var base64 = btoa(JSON.stringify(query));
                console.log(base64);
                console.log(query);

                document.cookie = "query=" + base64 + "; path=/";


                alert("saved!");
            })
        }

        mongo_query(map, count, render, false);
    </script>
</head>
<body>
    <form>
        <p>
            <label for="from">from:</label><input type="datetime-local" id="from"></br>
            <label for="to">to:</label><input type="datetime-local" id="to">
        </p>
        <p id="newspapers">
            <!-- this is autogenerated -->
        </p>
    </form>
</body>
</html>
